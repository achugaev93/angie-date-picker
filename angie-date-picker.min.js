angular.module("angie.datePicker",[]).value("datePickerOptions",{modelDateFormat:"DD-MM-YYYY",viewDateFormat:"DD MMMM YYYY",header:!0,calendar:!0,time:!0,controls:!0,unitsMap:{years:"years",months:"months",weeks:"weeks",days:"days",hours:"hours",minutes:"minutes",seconds:"seconds",am:"hours"},steps:{years:1,months:1,weeks:1,days:1,am:12,hours:1,minutes:1,seconds:1},autoIncrement:{years:1,months:1,weeks:1,days:1,am:12,hours:1,minutes:10,seconds:10},autoIncrementInterval:250,position:"bl",spacing:1,template:'    <div class="ngldp" ng-class="{\'ngldp--inline\': isInline}">        <div class="ngldp__head" ng-show="showHeader">            <div class="ngldp__prev-month">                <button type="button"                        class="ngldp__btn ngldp__btn--prev"                        ng-keydown="isActivateKey($event) && prev(\'months\')"                         ng-click="prev(\'months\')">prev</button>            </div>            <div class="ngldp__current-month">{{ currentDate.format(\'MMMM\') }}</div>            <div class="ngldp__next-month">                <button type="button"                        class="ngldp__btn ngldp__btn--next"                        ng-keydown="isActivateKey($event) && next(\'months\')"                         ng-click="next(\'months\')">next</button>            </div>            <div class="ngldp__prev-year">                <button type="button"                        class="ngldp__btn ngldp__btn--prev"                        ng-keydown="isActivateKey($event) && prev(\'years\')"                         ng-click="prev(\'years\')">prev</button>            </div>            <div class="ngldp__current-year">{{ currentDate.format(\'YYYY\') }}</div>            <div class="ngldp__next-year">                <button type="button"                        class="ngldp__btn ngldp__btn--next"                        ng-keydown="isActivateKey($event) && next(\'years\')"                         ng-click="next(\'years\')">next</button>            </div>        </div>        <div class="ngldp__calendar-wrapper" ng-show="showCalendar">            <div class="ngldp__body">                <table class="ngldp__calendar">                    <thead class="ngldp__dows">                        <tr>                            <th class="ngldp__dow"                                ng-repeat="day in daysNames"                                ng-class="{\'ngldp__day--weekend\': day.weekend}">{{ day.name }}</th>                        </tr>                    </thead>                    <tbody>                        <tr class="ngldp__week" ng-repeat="week in weeks">                            <td class="ngldp__day"                                 tabindex="{{ day.inactive ? \'\' : 0 }}"                                ng-repeat="day in week"                                ng-click="selectDay(day)"                                ng-keydown="isActivateKey($event) && selectDay(day)"                                ng-class="{\'ngldp__day--inactive\': day.inactive, \'ngldp__day--today\': day.today, \'ngldp__day--selected\': currentDate.date() == day.number && !day.inactive, \'ngldp__day--weekend\': day.weekend}">                                {{ day.number }}                            </td>                        </tr>                    </tbody>                </table>            </div>        </div>        <div class="ngldp__time-wrapper" ng-show="showTime">            <div class="ngldp__body">                <table class="ngldp__time">                    <tr>                        <td><button type="button"                                     class="ngldp__btn ngldp__up-btn"                                     ng-mousedown="add(steps.hours, \'hours\'); startAutoIncrement(\'hours\')"                                     ng-keydown="isActivateKey($event) && add(steps.hours, \'hours\')"                                     ng-click="endAutoIncrement()"                                     ng-mouseleave="endAutoIncrement()">add hour</button>                        </td>                        <td> </td>                        <td><button type="button"                                    class="ngldp__btn ngldp__up-btn"                                    ng-mousedown="add(steps.minutes, \'minutes\'); startAutoIncrement(\'minutes\')"                                    ng-keydown="isActivateKey($event) && add(steps.minutes, \'minutes\')"                                     ng-click="endAutoIncrement()"                                    ng-mouseleave="endAutoIncrement()">add minute</button>                        </td>                        <td><button type="button"                                    class="ngldp__btn ngldp__up-btn"                                    ng-mousedown="add(steps.am, \'hours\'); startAutoIncrement(\'am\')"                                    ng-keydown="isActivateKey($event) && add(steps.am, \'hours\')"                                     ng-click="endAutoIncrement()"                                    ng-mouseleave="endAutoIncrement()">add half a day</button>                        </td>                    </tr>                    <tr>                        <td><div class="ngldp__time-box">{{ currentDate.format(\'hh\') }}</div></td>                        <td> : </td>                        <td><div class="ngldp__time-box">{{ currentDate.format(\'mm\') }}</div></td>                        <td>{{ currentDate.format(\'A\') }}</td>                    </tr>                    <tr>                        <td><button type="button"                                     class="ngldp__btn ngldp__down-btn"                                    ng-mousedown="subtract(steps.hours, \'hours\'); startAutoDecrement(\'hours\')"                                    ng-keydown="isActivateKey($event) && subtract(steps.hours, \'hours\')"                                     ng-click="endAutoIncrement()"                                    ng-mouseleave="endAutoIncrement()">subtract hour</button>                        </td>                        <td> </td>                        <td><button type="button"                                    class="ngldp__btn ngldp__down-btn"                                    ng-mousedown="subtract(steps.minutes, \'minutes\'); startAutoDecrement(\'minutes\')"                                    ng-keydown="isActivateKey($event) && subtract(steps.minutes, \'minutes\')"                                     ng-click="endAutoIncrement()"                                    ng-mouseleave="endAutoIncrement()">subtract minute</button>                         </td>                        <td><button type="button"                                    class="ngldp__btn ngldp__down-btn"                                    ng-mousedown="subtract(steps.am, \'hours\'); startAutoDecrement(\'am\')"                                    ng-keydown="isActivateKey($event) && subtract(steps.am, \'hours\')"                                     ng-click="endAutoIncrement()"                                    ng-mouseleave="endAutoIncrement()">subtract half a day</button>                        </td>                    </tr>                </table>            </div>        </div>        <div class="ngldp__controls" ng-show="showControls">            <button type="button"                    class="ngldp__btn ngldp__btn--today"                    ng-show="showCalendar"                    ng-click="selectToday()">Today</button>            <button type="button"                    class="ngldp__btn ngldp__btn--ok"                    ng-click="close()">Ok</button>        </div>    </div>    '}).directive("datePicker",["$compile","$interval","datePickerOptions",function(t,e,n){var a=angular.element(document.body);return{restrict:"EA",require:"ngModel",scope:{model:"=ngModel",datePicker:"=",options:"="},link:function(s,o,r,d){function c(t,e){var n=moment(t);n.date(e);var a=n.day();return 0===a||6===a}function u(t,e){var n=moment(),a=moment(t);return a.date(e),a.isSame(n,"day")}function i(){var t={},e=o[0].getBoundingClientRect(),n=y[0].getBoundingClientRect(),a=e.left+window.scrollX,r=e.top+window.scrollY,d=e.width,c=e.height,u=n.width,i=n.height;switch(s.position){case"cm":case"mc":t.x=a+(d/2-u/2),t.y=r+(c/2-i/2);break;case"lm":t.x=a-u-b.spacing,t.y=r+(c/2-i/2);break;case"lt":t.x=a-u-b.spacing,t.y=r;break;case"lb":t.x=a-u-b.spacing,t.y=r+c-i;break;case"rm":t.x=a+d+b.spacing,t.y=r+(c/2-i/2);break;case"rt":t.x=a+d+b.spacing,t.y=r;break;case"rb":t.x=a+d+b.spacing,t.y=r+c-i;break;case"bl":t.x=a,t.y=r+c+b.spacing;break;case"bc":t.x=a+(d/2-u/2),t.y=r+c+b.spacing;break;case"br":t.x=a+d-u,t.y=r+c+b.spacing;break;case"tl":t.x=a,t.y=r-i-b.spacing;break;case"tc":t.x=a+(d/2-u/2),t.y=r-i-b.spacing;break;case"tr":t.x=a+d-u,t.y=r-i-b.spacing}return t.x+="px",t.y+="px",t}function l(){s.currentDate&&(d.$setViewValue(s.currentDate.format(b.modelDateFormat)),d.$render(),o.prop("value",s.currentDate.format(b.viewDateFormat)))}function m(t,e){return"string"==typeof t?moment(t,b.modelDateFormat):t?moment(t):e||null}function p(){s.min&&moment.min(s.currentDate,s.min)==s.currentDate&&(s.currentDate=s.min.clone()),s.max&&moment.max(s.currentDate,s.max)==s.currentDate&&(s.currentDate=s.max.clone())}var g,y,b=s.datePicker||s.options||{},v="DATE-PICKER"===o.prop("tagName");b.modelDateFormat=b.modelDateFormat||n.modelDateFormat,b.viewDateFormat=b.viewDateFormat||n.viewDateFormat,b.spacing=b.spacing||n.spacing||0,b.steps=b.steps||n.steps,b.autoIncrement=b.autoIncrement||n.autoIncrement,b.autoIncrementInterval=b.autoIncrementInterval||n.autoIncrementInterval,Object.keys(n.autoIncrement).forEach(function(t){b.autoIncrement[t]=b.autoIncrement[t]||n.autoIncrement[t]}),Object.keys(n.steps).forEach(function(t){b.steps[t]=b.steps[t]||n.steps[t]}),s.isInline=v,s.steps=b.steps,s.position=b.position||n.position,s.min=m(b.min),s.max=m(b.max),s.currentDate=m(s.model,moment()),s.daysNames=[],s.weeks=[],s.showCalendar="boolean"==typeof b.calendar?b.calendar:n.calendar,s.showTime="boolean"==typeof b.time?b.time:n.time,s.showHeader="boolean"==typeof b.header?b.header:n.header,s.showControls="boolean"==typeof b.controls?b.controls:n.controls,s.getDaysNames=function(){s.daysNames=[];for(var t=moment("4/1/1970","D/M/YYYY"),e=0;7>e;e++)s.daysNames.push({name:t.format("dd"),weekend:0==e||6==e}),t.add(1,"days")},s.getDaysNames(),s.getMonthDays=function(){var t,e=moment(s.currentDate).startOf("month"),n=moment(s.currentDate).endOf("month"),a=e.day(),o=n.day(),r=s.currentDate.daysInMonth(),d=[];for(t=0;r>t;t++)d.push({number:t+1,inactive:e.clone().date(t+1).isBefore(s.min)||e.clone().date(t+1).isAfter(s.max),weekend:c(s.currentDate,t+1),today:u(s.currentDate,t+1)});var i=e.subtract(1,"days").date();for(t=0;a>t;t++)d.unshift({number:i,inactive:!0,weekend:c(e,i)}),e.subtract(1,"days"),i--;for(t=o;6>t;t++)n.add(1,"days"),d.push({number:n.date(),inactive:!0,weekend:c(n,n.date())});for(s.weeks.length=0,t=0;t<d.length/7;t++)s.weeks.push(d.slice(7*t,7*(t+1)))},s.open=function(){s.getDaysNames(),s.getMonthDays(),g=angular.element('<div class="ngldp__backdrop"></div>'),y=t(n.template)(s),v||s.$apply(),v||g.on("click",function(){s.close()});var e;v||(e=i(),y.css("left",e.x),y.css("top",e.y)),v?(o.empty(),o.append(y)):(a.append(g),a.append(y)),v||(e=i(),y.css("left",e.x),y.css("top",e.y)),"function"==typeof b.onOpen&&b.onOpen()},v&&s.open(),s.close=function(){y&&(y&&(y.remove(),y=null),g&&(g.remove(),g=null),"function"==typeof b.onClose&&b.onClose())},p(),s.prev=function(t){s.currentDate.subtract(b.steps[t],n.unitsMap[t]),p(),s.getMonthDays(),l()},s.next=function(t){s.currentDate.add(b.steps[t],n.unitsMap[t]),p(),s.getMonthDays(),l()},s.selectDay=function(t){t.inactive||(s.currentDate.date(t.number),p(),l())},s.selectToday=function(){s.currentDate=moment(),p(),s.getMonthDays(),l()},s.add=function(t,e){s.currentDate.add(t,e),p(),s.getMonthDays(),l()},s.subtract=function(t,e){s.currentDate.subtract(t,e),p(),s.getMonthDays(),l()};var _=[];s.startAutoIncrement=function(t){s.endAutoIncrement(),_.push(e(function(){s.add(b.autoIncrement[t],n.unitsMap[t])},b.autoIncrementInterval))},s.startAutoDecrement=function(t){s.endAutoIncrement(),_.push(e(function(){s.subtract(b.autoIncrement[t],n.unitsMap[t])},b.autoIncrementInterval))},s.endAutoIncrement=function(){_.forEach(function(t){e.cancel(t)}),_.length=0},s.isActivateKey=function(t){var e=32===t.which||13===t.which;return e&&t.preventDefault(),e},v||(o.prop("readOnly",!0),o.on("click",function(){s.open()})),l()}}}]);